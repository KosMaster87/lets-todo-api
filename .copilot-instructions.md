# Backend Copilot Instructions - RESTful Notes API

## Projektstruktur

````instructions
# Backend Copilot Instructions - RESTful Notes API

## Projektstruktur

```
restful-notes-user-session-backend/
├── server.js               # Express-Server Setup mit Environment-Detection
├── db.js                   # MariaDB Pool-Management (Core, User, Gast)
├── package.json            # Dependencies und Scripts
├── nodemon.json            # Nodemon-Konfiguration
├── .env                    # Production Environment Variables
├── .env.development        # Development Environment Variables
├── .gitignore              # Git Ignore Rules
├── config/
│   └── environment.js      # Environment-Detection und -Konfiguration
├── routing/
│   ├── authRouter.js       # User-Authentifizierung (Register/Login/Logout)
│   ├── sessionRouter.js    # Session-Management (User/Gast-Sessions)
│   └── todosRouter.js      # Todo-CRUD mit Pool-Middleware
├── middleware/
│   └── poolMiddleware.js   # Database-Pool-Zuweisung basierend auf Session
├── scripts/
│   └── setup-dev-db.js     # Development-Database Setup Script
└── DEVELOPMENT.md          # Development Setup Guide
```

## Technologie-Stack

### Core Dependencies
- **Express.js** - Web-Framework mit ES6-Modulen
- **mysql2** - MariaDB-Driver mit Promise-Support
- **bcrypt** - Passwort-Hashing für User-Authentifizierung
- **cors** - Cross-Origin Resource Sharing mit Environment-Config
- **cookie-parser** - Cookie-Management für Sessions
- **uuid** - UUID-Generierung für Gast-Sessions
- **dotenv** - Environment Variables Management

### Development Dependencies
- **nodemon** - Auto-Reload mit Environment-Detection

## Architecture Overview

### Environment-Management
- **Automatische Environment-Detection**: Development vs Production
- **Config in `config/environment.js`**: Zentrale Konfiguration
- **Environment-Files**: `.env.development` und `.env` für verschiedene Umgebungen
- **Dynamic API URLs**: Frontend erkennt automatisch Backend-URLs

### Database Architecture
- **Multi-Database Approach**: Separate DB pro User/Gast für Datenisolation
- **Pool-Management**: Core-Pool (DDL), User-Pool (zentral), Guest-Pools (dynamisch)
- **Automatic Database Creation**: Neue DBs werden automatisch erstellt
- **Session-based Pool Assignment**: Middleware weist korrekte DB-Pools zu

## API-Design Prinzipien

### 1. RESTful Endpoints
```
Auth (User-Management):
- POST /api/register       # Benutzer-Registrierung mit eigener DB
- POST /api/login          # Benutzer-Login mit Cookie-Session
- POST /api/logout         # Benutzer-Logout und Cookie-Clearing

Session (Guest & User Sessions):
- POST /api/session/guest     # Gast-Session starten (UUID + temp DB)
- GET  /api/session/validate  # Session-Validierung (User oder Gast)
- POST /api/session/guest/end # Gast-Session beenden und DB löschen

Todos (CRUD mit Session-Context):
- GET    /api/todos        # Alle Todos der aktuellen Session
- GET    /api/todos/:id    # Einzelnes Todo abrufen
- POST   /api/todos        # Neues Todo erstellen
- PATCH  /api/todos/:id    # Todo teilweise aktualisieren (COALESCE)
- DELETE /api/todos/:id    # Todo löschen
```

### 2. Session-Management
- **Cookie-basierte Sessions**: httpOnly=false für Frontend-Zugriff
- **Strikte Session-Trennung**: User-Session schließt Gast aus
- **Environment-aware Cookies**: Secure/Domain basierend auf Environment
- **Pool-Middleware**: Automatische DB-Pool-Zuweisung pro Session
- **Session-Rekonstruktion**: Fehlende Pools werden aus DB rekonstruiert

### 3. Error-Handling
- **Konsistente Error-Response-Struktur**:
```json
{
  "error": "Fehlerbeschreibung",
  "message": "Detaillierte Erklärung"
}
```
- **Environment-specific Logging**: Debug-Logs nur in Development
- **Graceful Degradation**: Sessions werden bei Fehlern bereinigt

### 4. Database-Schema

#### Users Database (`notes_users_dev` / `notes_users`)
```sql
CREATE TABLE users (
  id INT AUTO_INCREMENT PRIMARY KEY,
  email VARCHAR(255) UNIQUE NOT NULL,
  password_hash VARCHAR(255) NOT NULL,
  db_name VARCHAR(255) NOT NULL,
  created BIGINT
);
```

#### User/Guest Todos Database (pro Session eine eigene DB)
```sql
CREATE TABLE todos (
  id INT AUTO_INCREMENT PRIMARY KEY,
  title TEXT NOT NULL,
  description TEXT,
  created BIGINT,
  updated BIGINT,
  completed TINYINT
);
```

## Coding Standards

### 1. Dateistruktur
- **ES6 Modules**: Import/Export statt CommonJS
- **Ein Modul pro Datei**: Klare Trennung von Concerns
- **Async/Await**: Für alle asynchronen Operationen
- **Environment-Detection**: Automatische Development/Production-Erkennung
- **Proper Error-Handling**: Try/catch mit Environment-spezifischem Logging

### 2. Security Best Practices
- **Passwort-Hashing**: bcrypt mit Salt für User-Authentifizierung
- **SQL-Injection Prevention**: Prepared Statements für alle Queries
- **Environment-aware CORS**: Development vs Production Origins
- **Cookie Security**: httpOnly=false für Frontend, secure nur in Production
- **Input-Validierung**: Request-Body-Validierung in Routen

### 3. Database-Patterns
- **Connection-Pooling**: Separate Pools für Core/User/Guest-Operations
- **Prepared Statements**: Für alle SQL-Queries
- **Database-per-Session**: Vollständige Datenisolation
- **Pool-Lifecycle-Management**: Automatisches Cleanup bei Session-Ende
- **Fail-Fast Connection Testing**: App startet nur bei funktionierender DB

## Module und Komponenten

### Core-Module

#### `config/environment.js`
- **Environment-Detection**: Automatische Development/Production-Erkennung
- **Zentrale Konfiguration**: Database, Server, CORS, Cookies
- **Logging-Functions**: debugLog, infoLog, errorLog mit Environment-Filter
- **Export**: ENV, ENVIRONMENT, Logging-Functions

#### `db.js`
- **Pool-Management**: Core-Pool (DDL), User-Pool (zentral), Guest-Pools (dynamisch)
- **Connection-Testing**: Fail-Fast Pattern beim App-Start
- **Pool-Maps**: guestPools, userPools für Session-Management
- **Export**: corePool, userPool, guestPools, userPools

#### `middleware/poolMiddleware.js`
- **assignPoolMiddleware**: Basis-Pool-Zuweisung basierend auf Cookies
- **enhancedPoolMiddleware**: Pool-Rekonstruktion aus Database
- **Session-Priorität**: User-Session hat Vorrang vor Gast-Session
- **Cookie-Cleanup**: Ungültige Sessions werden bereinigt

### Router-Module

#### `routing/authRouter.js`
- **POST /register**: User-Registrierung + eigene DB-Erstellung
- **POST /login**: User-Login + Cookie-Setzung
- **POST /logout**: Cookie-Clearing
- **User-Pool-Management**: Automatische Pool-Erstellung für neue User

#### `routing/sessionRouter.js`
- **POST /session/guest**: Gast-Session + temporäre DB-Erstellung
- **GET /session/validate**: Session-Validierung (User oder Gast)
- **POST /session/guest/end**: Gast-Session + DB-Cleanup
- **Environment-aware Cookies**: Secure/Domain basierend auf ENV

#### `routing/todosRouter.js`
- **Vollständiges CRUD**: GET, POST, PATCH, DELETE für Todos
- **PATCH mit COALESCE**: Partielle Updates mit SQL-COALESCE
- **Pool-abhängig**: Nutzt req.pool von Middleware
- **Session-isoliert**: Todos nur in aktueller Session-DB

### Scripts

#### `scripts/setup-dev-db.js`
- **Development-DB-Setup**: Automatische Erstellung der User-DB
- **Test-User-Erstellung**: Optional für Entwicklung
- **Environment-Detection**: Nur für Development-Environment
- **Nutzung**: `npm run dev:db`

## Environment Configuration

### Development Environment (`.env.development`)
```env
# Database Configuration (lokale Entwicklung)
DB_HOST=127.0.0.1
DB_PORT=3306
DB_USER=root
DB_PASSWORD=
DB_NAME=notes_dev
DB_USERS=notes_users_dev

# Server Configuration
PORT=3000
NODE_ENV=development

# Development-spezifische Einstellungen
DEBUG=true
LOG_LEVEL=verbose
```

### Production Environment (`.env`)
```env
# Database Configuration (Production)
DB_HOST=127.0.0.1
DB_PORT=3306
DB_USER=derBenutzer
DB_PASSWORD=desBenutzersPasswort
DB_NAME=RESTful-API-notes
DB_USERS=notes_users

# Server Configuration
PORT=3000
NODE_ENV=production
```

### Environment-Detection
Das System erkennt automatisch:
- **Development**: NODE_ENV=development ODER lokale Pfade (/home/, /Users/)
- **Production**: SERVER-Environment oder explizit gesetzt
- **Database-Hosts**: 127.0.0.1/localhost = Development-Indikator

### CORS-Konfiguration
- **Development**: Alle lokalen Ports (5500, 5501, 8000, 8080)
- **Production**: Nur lets-todo-api.dev2k.org
- **Cookie-Domain**: Undefined (Development) vs .dev2k.org (Production)

## Development Workflow

### Initial Setup
```bash
# 1. MariaDB/MySQL installieren und starten
sudo systemctl start mariadb
sudo systemctl enable mariadb

# 2. Ins Backend-Verzeichnis wechseln
cd restful-notes-user-session-backend

# 3. Dependencies installieren
npm install

# 4. Development-Datenbank einrichten
npm run dev:db

# 5. Development-Server starten
npm run dev
```

### NPM Scripts
- **`npm run dev`**: Development-Server mit Nodemon und AUTO-RELOAD
- **`npm run dev:db`**: Development-Database Setup (einmalig)
- **`npm start`**: Production-Server ohne Auto-Reload
- **`npm run prod`**: Explicit Production-Modus

### Database-Management
- **Automatische DB-Erstellung**: User- und Gast-DBs werden automatisch erstellt
- **Development-Reset**: `npm run dev:db` erstellt neue Development-DBs
- **Pool-Cleanup**: Connections werden automatisch bereinigt
- **Database-per-Session**: Jeder User/Gast hat eigene isolierte DB

### Port-Konfiguration
- **Backend Development**: http://127.0.0.1:3000
- **Frontend Development**: http://127.0.0.1:5501 (Live Server)
- **Production**: Konfigurierbar via PORT Environment Variable

## Testing & Debugging

### API-Testing
- **Thunder Client/Postman**: Für REST-API Tests
- **Cookie-Testing**: Cookies müssen bei Requests mitgesendet werden
- **Session-Isolation**: User- und Gast-Sessions haben separate DBs
- **Environment-Testing**: Development vs Production Cookie-Verhalten

### Debug-Logging
```javascript
// Environment-spezifisches Logging nutzen
import { debugLog, infoLog, errorLog } from './config/environment.js';

debugLog('Nur in Development sichtbar', data);
infoLog('Info-Level Logging', data);
errorLog('Fehler-Logging', error);
```

### Common Debugging Scenarios
- **Cookie-Probleme**: Prüfen ob sameSite/secure korrekt gesetzt
- **Pool-Fehler**: Pool-Assignment-Middleware prüfen
- **DB-Connection**: MariaDB-Status und Zugangsdaten verifizieren
- **Environment-Detection**: Welches Environment wird erkannt?

### Database-Debugging
```bash
# MariaDB-Status prüfen
sudo systemctl status mariadb

# Database-Liste anzeigen
mysql -u root -p -e "SHOW DATABASES;"

# User-Sessions prüfen
mysql -u root -p notes_users_dev -e "SELECT * FROM users;"
```

## Production Considerations

### Deployment
- **Environment-Variables**: .env-Datei für Production-Secrets
- **Database-Pooling**: Connection-Limits für Production optimieren
- **CORS-Security**: Nur vertrauenswürdige Origins erlauben
- **Cookie-Security**: secure=true, httpOnly=false für Frontend-Zugriff

### Performance
- **Pool-Caching**: Guest-Pools werden für Performance gecacht
- **Connection-Limits**: Environment-spezifische Connection-Limits
- **Database-Cleanup**: Automatisches Cleanup für beendete Gast-Sessions
- **Logging-Level**: Error-only in Production

### Security
- **Password-Hashing**: bcrypt mit 10 Rounds für User-Passwörter
- **SQL-Injection Prevention**: Prepared Statements für alle Queries
- **Session-Isolation**: Database-per-Session für vollständige Trennung
- **Environment-aware Security**: Development vs Production Cookie-Settings

### Monitoring
- **Health-Checks**: Database-Connection-Tests beim App-Start
- **Error-Logging**: Strukturiertes Logging für Production-Monitoring
- **Session-Tracking**: User- und Gast-Session-Metriken
- **Database-Metrics**: Pool-Usage und Connection-Status

````
